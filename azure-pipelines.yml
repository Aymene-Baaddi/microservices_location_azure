trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  dockerRegistryServiceConnection: 'mywebapp'
  containerRegistry: 'mywebapp.azurecr.io'
  dockerComposeFile: 'docker-compose.yml'
  SONARQUBE_SERVICE_CONNECTION: 'bd-sonarcube'

jobs:
- job: SonarQubeAnalysisBackend
  displayName: 'SonarQube Analysis for Spring Boot Microservices'
  steps:
    - task: JavaToolInstaller@0
      inputs:
        versionSpec: '21'
        jdkArchitectureOption: 'x64' 
        jdkSourceOption: 'PreInstalled'
      displayName: 'Install Java 21'
    - script: |
        for service in micro-back-voiture micro-back-favori micro-back-reservation micro-back-user micro-back-admin micro-back-api-gateway micro-back-discovery; do
          echo "Running SonarQube analysis for $service"
          cd ./micro-back-all/$service
          mvn clean verify sonar:sonar -Dsonar.projectKey=$(basename $service) -Dsonar.projectName=$(basename $service) -Dsonar.host.url=$(SONARQUBE_SERVICE_CONNECTION) 
          cd ../..
        done
      displayName: 'Run SonarQube Analysis for Backend Microservices'

- job: SonarQubeAnalysisFrontend
  displayName: 'SonarQube Analysis for React Microservices'
  steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '14.x'
      displayName: 'Install Node.js'
      
    - script: |
        for service in micro-front-admin micro-front-visiteur; do
          echo "Running SonarQube analysis for $service"
          cd $service
          npm install
          npm run build
          sonar-scanner -Dsonar.projectKey=AT2Car_AT2Car_AZDLVLU0MtnHEKMgnRun -Dsonar.projectName=AT2Car -Dsonar.sources=src -Dsonar.host.url=$(SONARQUBE_SERVICE_CONNECTION)
          cd ..
        done
      displayName: 'Run SonarQube Analysis for Frontend Microservices'

- job: DockerBuildAndPush
  displayName: 'Build and Push Docker Images'
  dependsOn: 
    - SonarQubeAnalysisBackend
    - SonarQubeAnalysisFrontend
  steps:
    - task: DockerCompose@0
      displayName: 'Build Docker Compose Images'
      inputs:
        action: 'Build services'
        dockerComposeFile: '$(dockerComposeFile)'
        qualifyImageNames: true
        additionalImageTags: |
          $(Build.BuildId)
          latest
        containerregistry: '$(dockerRegistryServiceConnection)'

    - task: Docker@2
      displayName: 'Login to ACR'
      inputs:
        command: 'login'
        containerRegistry: '$(dockerRegistryServiceConnection)'

    - task: DockerCompose@0
      displayName: 'Push Docker Compose Images'
      inputs:
        action: 'Push services'
        dockerComposeFile: '$(dockerComposeFile)'
        qualifyImageNames: true
        additionalImageTags: |
          $(Build.BuildId)
          latest
        containerregistry: '$(dockerRegistryServiceConnection)'
